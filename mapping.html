<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM CRUD with Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
            font-size: 2.5em;
            color: #4CAF50;
        }

        #map {
            width: 80%;
            height: 500px;
            margin: 20px auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>UMKM Map with Leaflet</h1>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Inisialisasi peta dengan posisi awal di Sukorame, Kediri
        const map = L.map('map').setView([-7.8234, 112.0145], 13);

        // Tambahkan layer peta dari OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Data lokasi UMKM (80 data dummy)
        const umkmLocations = Array.from({ length: 80 }, (_, i) => {
            return {
                name: `UMKM ${i + 1}`,
                lat: -7.82 + (Math.random() * 0.02 - 0.01), // Variasi latitude
                lng: 112.01 + (Math.random() * 0.02 - 0.01), // Variasi longitude
                description: `Deskripsi UMKM ${i + 1}`
            };
        });

        // Tambahkan marker untuk setiap lokasi UMKM
        umkmLocations.forEach(umkm => {
            const marker = L.marker([umkm.lat, umkm.lng]).addTo(map);
            marker.bindPopup(`<b>${umkm.name}</b><br>${umkm.description}`);
        });
    </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM CRUD with SheetBest and Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1, h2 {
            text-align: center;
            color: #4CAF50;
        }

        h1 {
            margin-top: 30px;
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 40px;
            color: #333;
        }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        td img {
            width: 100px;
            height: auto;
            border-radius: 5px;
        }

        #map {
            width: 80%;
            height: 400px;
            margin: 40px auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #add-form {
            max-width: 600px;
            margin: 40px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #add-form input, #add-form textarea, #add-form button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #add-form input[type="file"] {
            padding: 5px;
            background-color: #f9f9f9;
        }

        #add-form button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

        #add-form button:hover {
            background-color: #45a049;
        }

        input:focus, textarea:focus, button:focus {
            outline: none;
            border-color: #4CAF50;
        }

        a {
            color: #4CAF50;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        #filter-box {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>UMKM CRUD with SheetBest and Map</h1>

    <div style="text-align: center; margin-top: 20px;">
    <input type="text" id="filter-box" placeholder="Cari UMKM..." style="padding: 10px; width: 60%; max-width: 400px;">
    <button id="search-button" style="padding: 10px 20px; margin-left: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">Cari</button>
</div>
    
    <h2>Data UMKM</h2>
    <table id="spreadsheet-table">
        <thead></thead>
        <tbody></tbody>
    </table>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const apiUrl = "https://api.sheetbest.com/sheets/12b8e083-dc1e-4e75-ad60-84397d9b2db0";
        let mapData = [];  // Store map data globally for filtering
        const markers = [];  // To store map markers and easily manage them

        // Initialize map with Sukorame, Kediri coordinates
        const map = L.map('map').setView([-7.8234, 112.0145], 13); // Zoom level 13 for a closer view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

         // Define the polygon for RW 1
        const rw1Coordinates = [
            [-7.8112830, 111.9951902],
            [-7.8101433, 111.9955186],
            [-7.8099414, 111.9950175],
            [-7.8097424, 111.9950738],
            [-7.8094009, 111.9939459],
            [-7.8099912, 111.9937411],
            [-7.8098364, 111.9932814],
            [-7.8113358, 111.9928057]
        ];

        // Add the polygon to the map
        const rw1Polygon = L.polygon(rw1Coordinates, {
            color: '#DCE4C9',
            fillColor: '#DCE4C9',
            fillOpacity: 0.5
        }).addTo(map);

        // Define the polygon for RW 2
        const rw2Coordinates = [
            [-7.8139001, 111.9918485],
            [-7.8141299, 111.9930333],
            [-7.8131942, 111.9932468],
            [-7.8133175, 111.9936030],
            [-7.8122844, 111.9940294],
            [-7.8123286, 111.9922257],
            [-7.8125704, 111.9921076]
        ];

        // Add the polygon to the map for RW 2
        const rw2Polygon = L.polygon(rw2Coordinates, {
            color: '#F5F5DC',
            fillColor: '#F5F5DC',
            fillOpacity: 0.5
        }).addTo(map);

        // Define the polygon for RW 3
        const rw3Coordinates = [
            [-7.8113215, 111.9940369],
            [-7.8119360, 111.9940127],
            [-7.8118873, 111.9924646],
            [-7.8138273, 111.9915095],
            [-7.8131883, 111.9900423],
            [-7.8113232, 111.9906214]
        ];

        // Add the polygon to the map for RW 3
        const rw3Polygon = L.polygon(rw3Coordinates, {
            color: '#B6A28E',
            fillColor: '#B6A28E',
            fillOpacity: 0.5
        }).addTo(map);

        // Define the polygon for RW 4
        const rw4Coordinates = [
            [-7.8113683, 111.9927524],
            [-7.8113657, 111.9912815],
            [-7.8086303, 111.9922803],
            [-7.8093194, 111.9939778],
            [-7.8100031, 111.9937503],
            [-7.8098367, 111.9932885]
        ];

        // Add the polygon to the map for RW 4
        const rw4Polygon = L.polygon(rw4Coordinates, {
            color: '#9FBB73',
            fillColor: '#9FBB73',
            fillOpacity: 0.5
        }).addTo(map);

        // Define the polygon for RW 5
        // const rw5Coordinates = [
        //     [-7.8098367, 111.9932885],
        //     [-7.8084214, 111.9914632],
        //     [-7.8088572, 111.9912161],
        //     [-7.8096407, 111.9915926],
        //     [-7.8101074, 111.9907474],
        //     [-7.8117038, 111.9906341],
        //     [-7.8128249, 111.9896772],
        //     [-7.8126040, 111.9890274]
        // ];

        // // Add the polygon to the map for RW 5
        // const rw5Polygon = L.polygon(rw5Coordinates, {
        //     color: '#D4EBF8',
        //     fillColor: '#D4EBF8',
        //     fillOpacity: 0.5
        // }).addTo(map);

        // Define the polygon for RW 6
        const rw6Coordinates = [
            [-7.8080314, 111.9904175],
            [-7.8075046, 111.9887200],
            [-7.8082270, 111.9885631],
            [-7.8079965, 111.9874952],
            [-7.8091641, 111.9872042],
            [-7.8098179, 111.9899259]
        ];

        // Add the polygon to the map for RW 6
        const rw6Polygon = L.polygon(rw6Coordinates, {
            color: '#FFCCEA',
            fillColor: '#FFCCEA',
            fillOpacity: 0.5
        }).addTo(map);

        // Define the polygon for RW 8
        const rw8Coordinates = [
            [-7.8110531, 111.9884464],
            [-7.8125721, 111.9881256],
            [-7.8123439, 111.9871097],
            [-7.8119516, 111.9871834],
            [-7.8117493, 111.9865276],
            [-7.8107173, 111.9867539]
        ];

        // Add the polygon to the map for RW 8
        const rw8Polygon = L.polygon(rw8Coordinates, {
            color: '#A1EEBD',
            fillColor: '#A1EEBD',
            fillOpacity: 0.5
        }).addTo(map);


        // Fetch data from API
        function fetchSpreadsheetData() {
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    mapData = data; // Store the fetched data globally
                    displaySpreadsheetData(data);
                    placePinsOnMap(data);
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        // Display data in the table
        function displaySpreadsheetData(data) {
            const tableHead = document.querySelector("#spreadsheet-table thead");
            const tableBody = document.querySelector("#spreadsheet-table tbody");
            tableHead.innerHTML = ''; 
            tableBody.innerHTML = '';

            const headerRow = document.createElement("tr");
            const headers = ["Timestamp", "Nama Penanggung Jawab", "Nama UMKM", "Link Alamat", "Nomor Telepon", "Upload Foto", "Deskripsi UMKM"];
            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            data.forEach(row => {
                const tr = document.createElement("tr");
                Object.values(row).forEach(value => {
                    const td = document.createElement("td");
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function getCoordinatesFromAddress(address) {
    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    return fetch(geocodeUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text(); // Get the response as text
        })
        .then(text => {
            console.log("API Response:", text); // Log the raw response body
            try {
                const data = JSON.parse(text);
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error("Error parsing JSON:", error);
                return null;
            }
        })
        .catch(error => console.error("Error getting coordinates:", error));
}

        function placePinsOnMap(data) {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers.length = 0;

            data.forEach(async (row) => {
                const address = row["Link Alamat"];
                const coordinates = await getCoordinatesFromAddress(address);

                if (coordinates) {
                    const { lat, lon } = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);
                    markers.push(marker);

                    const popupContent = `
                        <b>Nama UMKM:</b> ${row["Nama UMKM"]}<br>
                        <b>Penanggung Jawab:</b> ${row["Nama Penanggung Jawab"]}<br>
                        <b>Alamat:</b> <a href="${row["Link Alamat"]}" target="_blank">${row["Link Alamat"]}</a><br>
                        <b>Nomor Telepon:</b> ${row["Nomor Telepon"]}<br>
                        <b>Deskripsi:</b> ${row["Deskripsi UMKM"]}<br>
                        <b>Foto:</b><br>
                        <img src="${row["Upload Foto"]}" alt="Foto UMKM">
                    `;
                    marker.bindPopup(popupContent);
                }
            });
        }

        // Form submission handler

        document.querySelector("#search-button").addEventListener("click", filterData);

        // let markers = [];

function filterData() {
    const filterText = document.querySelector("#filter-box").value.toLowerCase();
    
    // Filter the data, ensuring each value is valid before trying to match
    const filteredData = mapData.filter(row => {
        return Object.values(row).some(value => value && value.toLowerCase().includes(filterText));
    });

    // Display filtered data in the table
    displaySpreadsheetData(filteredData);
    
    // Place pins on the map for the filtered data
    placePinsOnMap(filteredData);
}

function placePinsOnMap(data) {
    // Clear existing markers
    markers.forEach(marker => marker.remove());
    markers.length = 0;  // Clear the markers array

    // Add new markers for the filtered data
    data.forEach(async (row) => {
        const lat = row["lat"];
        const lng = row["lng"];

        // If coordinates are valid, create and add marker
        if (lat && lng) {
            const marker = L.marker([lat, lng]).addTo(map);
            
            const popupContent = `
                <b>Nama UMKM:</b> ${row["Nama UMKM"]}<br>
                <b>Penanggung Jawab:</b> ${row["Nama Penanggung Jawab"]}<br>
                <b>Alamat:</b> <a href="${row["Link Alamat"]}" target="_blank">${row["Link Alamat"]}</a><br>
                <b>Nomor Telepon:</b> ${row["Nomor Telepon"]}<br>
                <b>Deskripsi:</b> ${row["Deskripsi UMKM"]}<br>
                <b>Foto:</b><br>
                <img src="${row["Upload Foto"]}" alt="Foto UMKM">
            `;
            marker.bindPopup(popupContent);
            markers.push(marker); // Store marker to be able to remove it later
        }
    });
}
        // Initial fetch
        fetchSpreadsheetData();
    </script>
</body>
</html>
