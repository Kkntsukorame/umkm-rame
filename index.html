<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMKM CRUD with SheetBest and Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1, h2 {
            text-align: center;
            color: #4CAF50;
        }

        h1 {
            margin-top: 30px;
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 40px;
            color: #333;
        }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        td img {
            width: 100px;
            height: auto;
            border-radius: 5px;
        }

        #map {
            width: 80%;
            height: 400px;
            margin: 40px auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #add-form {
            max-width: 600px;
            margin: 40px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #add-form input, #add-form textarea, #add-form button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #add-form input[type="file"] {
            padding: 5px;
            background-color: #f9f9f9;
        }

        #add-form button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
        }

        #add-form button:hover {
            background-color: #45a049;
        }

        input:focus, textarea:focus, button:focus {
            outline: none;
            border-color: #4CAF50;
        }

        a {
            color: #4CAF50;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        #filter-box {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1em;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>UMKM CRUD with SheetBest and Map</h1>

    <div>
        <input type="text" id="filter-box" placeholder="Cari UMKM...">
<button id="search-button">Cari</button>


    </div>
    
    <h2>Data UMKM</h2>
    <table id="spreadsheet-table">
        <thead></thead>
        <tbody></tbody>
    </table>

    <h2>Tambah UMKM Baru</h2>
    <form id="add-form">
        <input type="text" id="new-responsible" placeholder="Nama Penanggung Jawab" required><br>
        <input type="text" id="new-umkm-name" placeholder="Nama UMKM" required><br>
        <input type="text" id="new-address-link" placeholder="Link Alamat" required><br>
        <input type="text" id="new-phone" placeholder="Nomor Telepon" required><br>
        <input type="file" id="new-photo" required><br>
        <textarea id="new-description" placeholder="Deskripsi UMKM" required></textarea><br>
        <button type="submit">Tambah UMKM</button>
    </form>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const apiUrl = "https://api.sheetbest.com/sheets/12b8e083-dc1e-4e75-ad60-84397d9b2db0";
        let mapData = [];  // Store map data globally for filtering
        const markers = [];  // To store map markers and easily manage them

        // Initialize map with Sukorame, Kediri coordinates
        const map = L.map('map').setView([-7.8234, 112.0145], 13); // Zoom level 13 for a closer view

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch data from API
        function fetchSpreadsheetData() {
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    mapData = data; // Store the fetched data globally
                    displaySpreadsheetData(data);
                    placePinsOnMap(data);
                })
                .catch(error => console.error("Error fetching data:", error));
        }

        // Display data in the table
        function displaySpreadsheetData(data) {
            const tableHead = document.querySelector("#spreadsheet-table thead");
            const tableBody = document.querySelector("#spreadsheet-table tbody");
            tableHead.innerHTML = ''; 
            tableBody.innerHTML = '';

            const headerRow = document.createElement("tr");
            const headers = ["Timestamp", "Nama Penanggung Jawab", "Nama UMKM", "Link Alamat", "Nomor Telepon", "Upload Foto", "Deskripsi UMKM"];
            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            data.forEach(row => {
                const tr = document.createElement("tr");
                Object.values(row).forEach(value => {
                    const td = document.createElement("td");
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        function getCoordinatesFromAddress(address) {
    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    return fetch(geocodeUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.text(); // Get the response as text
        })
        .then(text => {
            console.log("API Response:", text); // Log the raw response body
            try {
                const data = JSON.parse(text);
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error("Error parsing JSON:", error);
                return null;
            }
        })
        .catch(error => console.error("Error getting coordinates:", error));
}

        function placePinsOnMap(data) {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers.length = 0;

            data.forEach(async (row) => {
                const address = row["Link Alamat"];
                const coordinates = await getCoordinatesFromAddress(address);

                if (coordinates) {
                    const { lat, lon } = coordinates;
                    const marker = L.marker([lat, lon]).addTo(map);
                    markers.push(marker);

                    const popupContent = `
                        <b>Nama UMKM:</b> ${row["Nama UMKM"]}<br>
                        <b>Penanggung Jawab:</b> ${row["Nama Penanggung Jawab"]}<br>
                        <b>Alamat:</b> <a href="${row["Link Alamat"]}" target="_blank">${row["Link Alamat"]}</a><br>
                        <b>Nomor Telepon:</b> ${row["Nomor Telepon"]}<br>
                        <b>Deskripsi:</b> ${row["Deskripsi UMKM"]}<br>
                        <b>Foto:</b><br>
                        <img src="${row["Upload Foto"]}" alt="Foto UMKM">
                    `;
                    marker.bindPopup(popupContent);
                }
            });
        }

        function addRow(data) {
            fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(() => {
                fetchSpreadsheetData(); // Refresh data after adding new row
            })
            .catch(error => console.error("Error adding row:", error));
        }

        // Form submission handler
        document.querySelector("#add-form").addEventListener("submit", function(event) {
            event.preventDefault();

            const responsible = document.querySelector("#new-responsible").value;
            const name = document.querySelector("#new-umkm-name").value;
            const addressLink = document.querySelector("#new-address-link").value;
            const phone = document.querySelector("#new-phone").value;
            const photo = document.querySelector("#new-photo").files[0];
            const description = document.querySelector("#new-description").value;

            if (!responsible || !name || !addressLink || !phone || !photo || !description) {
                alert("All fields are required!");
                return;
            }

            const reader = new FileReader();
            reader.onloadend = function () {
                const photoData = reader.result;
                const newEntry = {
                    "Nama Penanggung Jawab": responsible,
                    "Nama UMKM": name,
                    "Link Alamat": addressLink,
                    "Nomor Telepon": phone,
                    "Upload Foto": photoData,
                    "Deskripsi UMKM": description
                };

                addRow(newEntry);
            };

            reader.readAsDataURL(photo);
        });

        document.querySelector("#search-button").addEventListener("click", filterData);

function filterData() {
    const filterText = document.querySelector("#filter-box").value.toLowerCase();
    
    // Filter the data, ensuring each value is valid before trying to match
    const filteredData = mapData.filter(row => {
        return Object.values(row).some(value => value && value.toLowerCase().includes(filterText));
    });

    // Display filtered data in the table
    displaySpreadsheetData(filteredData);
    
    // Place pins on the map for the filtered data
    placePinsOnMap(filteredData);
}


function placePinsOnMap(data) {
    // Clear existing markers
    markers.forEach(marker => marker.remove());
    markers.length = 0;  // Clear the markers array

    // Add new markers for the filtered data
    data.forEach(async (row) => {
        const address = row["Link Alamat"];
        const coordinates = await getCoordinatesFromAddress(address);

        if (coordinates) {
            const { lat, lon } = coordinates;
            const marker = L.marker([lat, lon]).addTo(map);
            markers.push(marker);

            const popupContent = `
                <b>Nama UMKM:</b> ${row["Nama UMKM"]}<br>
                <b>Penanggung Jawab:</b> ${row["Nama Penanggung Jawab"]}<br>
                <b>Alamat:</b> <a href="${row["Link Alamat"]}" target="_blank">${row["Link Alamat"]}</a><br>
                <b>Nomor Telepon:</b> ${row["Nomor Telepon"]}<br>
                <b>Deskripsi:</b> ${row["Deskripsi UMKM"]}<br>
                <b>Foto:</b><br>
                <img src="${row["Upload Foto"]}" alt="Foto UMKM">
            `;
            marker.bindPopup(popupContent);
        }
    });
}


        // Initial fetch
        fetchSpreadsheetData();
    </script>
</body>
</html>
